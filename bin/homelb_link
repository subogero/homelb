#!/bin/sh
help() {
	cat <<EOF
Usage:
	homelb_link add <hostname>
	homelb_link del <hostname>
	homelb_link help
Create or delete a macvlan interface.
Whan adding, get IP config via DHCP, associating a hostname.
EOF
	exit
}

BIN=$(dirname `readlink -f "$0"`)
ETC=$BIN/../etc
VAR=$BIN/../var
cd $VAR

verb=$1
[ "$1" ] && shift
host=$1
[ "$1" ] && shift

n_link() {
	grep -n ^$host: macv | sed 's/:.*//'
} 

get_ip() {
	dev=$1
	ip addr show dev $dev | grep 'inet '
}

del_macv_routes() {
	route -n |\
	grep macv |\
	perl -lane 'print "route del -net $F[0] gw $F[1] netmask $F[2] $F[-1]"' |\
	sh
}

for i in `ip addr | sed -rn 's/^[0-9]+: (eth[0-9]+): .*/\1/p'`; do
	get_ip $i >/dev/null && interface=$i && break
done

case $verb in
*help)
	help
	;;
add)
	[ -f macv ] || echo $host: >>macv
	[ "$n" ] || n=`n_link`
	[ "$n" ] || perl -lpe "unless(@a){ s/^:/$host:/ and push@a,1 }" -i macv
	[ "$n" ] || n=`n_link`
	[ "$n" ] || echo $host: >>macv
	[ "$n" ] || n=`n_link`
	link=macv$n
	echo ip link add link $interface $link type macvlan >&2
	ip link add link $interface $link type macvlan
	ifconfig $link up
	echo dhcpcd-bin -h $host $link >&2
	dhcpcd-bin -G -R -P $link.pid -h $host $link
	sleep 1
	del_macv_routes
	;;
del)
	link=macv`n_link`
	sed "s/^$host:/:/" -i macv
	echo dhcpcd-bin -k $link >&2
	dhcpcd-bin -P $link.pid -k $link
	echo ip link delete $link >&2
	ip link delete $link
	;;
get)
	echo Physical interface=$interface >&2
	echo
	echo Link Hostname Mapping
	perl -lne 'print if s/(.+):/macv$. $1/' macv
	echo
	echo IP Configuration
	ip addr | grep 'inet ..* macv'
	echo
	echo DHCP Client Processes
	ps -fC dhcpcd-bin
	;;
ip)
	link=macv`n_link`
	get_ip $link | sed -r 's| *inet ([0-9.]+)/.*|\1|'
	;;
*)
	echo Unknown verb $verb >&2
	exit 1
	;;
esac
